syntax = "proto3";
package authzed.api.materialize.v0;

import "authzed/api/v1/core.proto";

option go_package = "github.com/authzed/authzed-go/proto/authzed/api/materialize/v0";
option java_multiple_files = true;
option java_package = "com.authzed.api.materialize.v0";

service BrokenSetsService {
  // ReadBrokenSets returns all broken sets detected during
  // the hydration process.
  //
  // Each broken set represents a circular dependency in the permission
  // graph. The response includes the sets involved in each cycle,
  // along with their associated resources.
  rpc ReadBrokenSets(ReadBrokenSetsRequest) returns (stream ReadBrokenSetsResponse) {}
}

message ReadBrokenSetsRequest {
  // batch_size specifies the maximum number of broken sets to return in a single response.
  // If set to zero, the server will use the default batch size.
  uint32 batch_size = 1;
  // optional_at_revision defines the specific revision at which the broken sets should be evaluated.
  // At this time, it is only compared against the revision of the provided backing store snapshot.
  authzed.api.v1.ZedToken optional_at_revision = 2;
}

message BrokenSet {
  // resource_type is the type of the broken resource.
  string resource_type = 1;
  // resource_id is the id of the broken resource.
  string resource_id = 2;
  // relation is the relation of this broken resource.
  string relation = 3;
}

message ReadBrokenSetsResponse {
  // broken_sets contains the list of broken sets found for the requested revision.
  repeated BrokenSet broken_sets = 1;
  // read_at is the ZedToken at which the broken set applies.
  authzed.api.v1.ZedToken revision = 2;
}
